---
title: "Full Modeling of Interior West"
author: "Grayson White"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

## Intro
This document contains the code for the five types of models used for comparison in this thesis: direct post-stratified estimator, area-level frequentist model, area-level hierarchical Bayesian model, unit-level frequentist model, and unit-level hierarchical Bayesian model. 

## Load data
```{r load_data, message = FALSE, warning = FALSE}
intwest <- read_csv("../data/subsets/dat_small.csv")
tccpop <- read_csv("../data/population/tcc_pop.csv")
strata <- read_csv("../data/population/strata.csv")
```

## Source modeling functions
```{r modeling_fcns}
source("../modeling-functions/direct_CoV.R")
source("../modeling-functions/direct_estimate.R")
source("../modeling-functions/freq_area.R")
source("../modeling-functions/freq_area_CoV.R")
source("../modeling-functions/freq_unit.R")
source("../modeling-functions/freq_unit_CoV.R")
source("../modeling-functions/hb_area.R")
source("../modeling-functions/hb_CoV.R")
source("../modeling-functions/hb_unit.R")
```

## Data setup

Initial data changes to avoid horrific errors:
```{r}
no0_subsections <- intwest %>%
  group_by(subsection) %>%
  summarize(mean_y = mean(BIOLIVE_TPA),
            mean_x = mean(nlcd11)) %>%
  filter(mean_y > 0 & mean_x > 0) %>% # remove subsections that only contain 0 
  dplyr::select(subsection) %>%
  pull()

intwest_no0 <- intwest %>%
  filter(subsection %in% no0_subsections)
```

List of dataframes:
```{r}
iw <- split(intwest_no0, f = intwest_no0$province)
iw <- iw[-13] # This province only has two subsections and causes divergent integrals
iw <- iw[-8] # This province only has two subsections and causes divergent integrals
```

## Modeling

```{r}
# HB Unit
bayes_unit <- list()
bayes_unit[1:12] <- lapply(iw, hb_unit, formula = BIOLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[13:24] <- lapply(iw, hb_unit, formula = BALIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[25:36] <- lapply(iw, hb_unit, formula = CNTLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[37:48] <- lapply(iw, hb_unit, formula = VOLNLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)

# saveRDS(bayes_unit, "bayes_unit.rds")

results <- data.frame(
  subsection = names(unlist(lapply(bayes_unit, EST))),
  response = c(rep("BIOLIVE_TPA", 428),
               rep("BALIVE_TPA", 428),
               rep("CNTLIVE_TPA", 428), 
               rep("VOLNLIVE_TPA", 428)),
  est_hb_unit = unlist(lapply(bayes_unit, EST)),
  cov_hb_unit = unlist(lapply(bayes_unit, hb_CoV))
)
```

```{r}
# HB Area
bayes_area <- list()
bayes_area[1:12] <- lapply(iw, hb_area, formula = BIOLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_area[13:24] <- lapply(iw, hb_area, formula = BALIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_area[25:36] <- lapply(iw, hb_area, formula = CNTLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_area[37:48] <- lapply(iw, hb_area, formula = VOLNLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)

# saveRDS(bayes_area, "bayes_area.rds")

aranged_df <- intwest_no0 %>%
  filter(province %in% names(iw)) %>%
  arrange(province) %>%
  arrange(subsection)
hb_area_res <- data.frame(
  subsection = rep(unique(aranged_df$subsection), 4),
  est_hb_area = unlist(lapply(bayes_area, EST)),
  cov_hb_area = unlist(lapply(bayes_area, hb_CoV)),
    response = c(rep("BIOLIVE_TPA", 428),
               rep("BALIVE_TPA", 428),
               rep("CNTLIVE_TPA", 428), 
               rep("VOLNLIVE_TPA", 428))
)

results <- results %>%
  left_join(hb_area_res, by = c("subsection" = "subsection",
                                "response" = "response"))
```



```{r}
# Freq Unit
frequnit <- list()
frequnit[1:12] <- lapply(iw, freq_unit, formula = BIOLIVE_TPA ~ nlcd11, "subsection", tccpop)
frequnit[13:24] <- lapply(iw, freq_unit, formula = BALIVE_TPA ~ nlcd11, "subsection", tccpop)
frequnit[25:36] <- lapply(iw, freq_unit, formula = CNTLIVE_TPA ~ nlcd11, "subsection", tccpop)
frequnit[37:48] <- lapply(iw, freq_unit, formula = VOLNLIVE_TPA ~ nlcd11, "subsection", tccpop)

# saveRDS(frequnit, "freq_unit.rds")

frequnit_list <- list()
  for(i in 1:48) {
    frequnit_list[[i]] <- frequnit[[i]]$eblup
  }

frequnit_df <- frequnit_list %>%
  bind_rows() %>%
  mutate(response = c(
    rep("BIOLIVE_TPA", 428),
    rep("BALIVE_TPA", 428),
    rep("CNTLIVE_TPA", 428),
    rep("VOLNLIVE_TPA", 428)
  )) %>%
  rename(
    subsection = domain,
    est_freq_unit = eblup
  ) %>%
  dplyr::select(-sampsize)

# Coef of variation
frequnitcov <- c()
frequnitcov <- c(
  Reduce(c,
       lapply(iw,
       freq_unit_CoV,
       formula = BIOLIVE_TPA ~ nlcd11,
       small_area = "subsection",
       pop_data = tccpop,
       B = 200)),
  Reduce(c,
       lapply(iw,
       freq_unit_CoV,
       formula = BALIVE_TPA ~ nlcd11,
       small_area = "subsection",
       pop_data = tccpop,
       B = 200)),
  Reduce(c,
       lapply(iw,
       freq_unit_CoV,
       formula = CNTLIVE_TPA ~ nlcd11,
       small_area = "subsection",
       pop_data = tccpop,
       B = 200)),
  Reduce(c,
       lapply(iw,
       freq_unit_CoV,
       formula = VOLNLIVE_TPA ~ nlcd11,
       small_area = "subsection",
       pop_data = tccpop,
       B = 200))
)

frequnitcov_df <- data.frame(
  cov_freq_unit = frequnitcov,
  subsection = names(frequnitcov),
  response = c(
    rep("BIOLIVE_TPA", 428),
    rep("BALIVE_TPA", 428),
    rep("CNTLIVE_TPA", 428),
    rep("VOLNLIVE_TPA", 428)
  )
)

frequnit_df <- frequnit_df %>%
  left_join(frequnitcov_df, by = c("subsection" = "subsection",
                                   "response" = "response"))

results <- results %>%
  left_join(frequnit_df, by = c("subsection" = "subsection",
                                   "response" = "response"))
```


```{r}
# Freq Area
freqarea <- list()
freqarea[1:12] <- lapply(iw, freq_area, formula = BIOLIVE_TPA ~ nlcd11, "subsection")
freqarea[13:24] <- lapply(iw, freq_area, formula = BALIVE_TPA ~ nlcd11, "subsection")
freqarea[25:36] <- lapply(iw, freq_area, formula = CNTLIVE_TPA ~ nlcd11, "subsection")
freqarea[37:48] <- lapply(iw, freq_area, formula = VOLNLIVE_TPA ~ nlcd11, "subsection")

freqarea_list <- list()
  for(i in 1:48) {
    freqarea_list[[i]] <- freqarea[[i]]$eblup
  }

# saveRDS(freqarea, "freq_area.rds")
freq_area_res <- data.frame(
  subsection = rep(unique(aranged_df$subsection), 4),
  est_freq_area = unlist(freqarea_list),
    response = c(rep("BIOLIVE_TPA", 428),
               rep("BALIVE_TPA", 428),
               rep("CNTLIVE_TPA", 428), 
               rep("VOLNLIVE_TPA", 428))
)
results <- results %>%
  left_join(freq_area_res,
            by = c("subsection" = "subsection",
                   "response" = "response"))

## coef of var
freqareacov <- c()
freqareacov <- c(
Reduce(c, lapply(
  iw,
  freq_area_CoV,
  formula = BIOLIVE_TPA ~ nlcd11,
  small_area = "subsection",
  B = 200)),
Reduce(c, lapply(
  iw,
  freq_area_CoV,
  formula = BALIVE_TPA ~ nlcd11,
  small_area = "subsection",
  B = 200)),
Reduce(c, lapply(
  iw,
  freq_area_CoV,
  formula = CNTLIVE_TPA ~ nlcd11,
  small_area = "subsection",
  B = 200)),
Reduce(c, lapply(
  iw,
  freq_area_CoV,
  formula = VOLNLIVE_TPA ~ nlcd11,
  small_area = "subsection",
  B = 200))
)

freq_area_res <- freq_area_res %>%
  mutate(
    cov_freq_area = freqareacov
  )

area_join <- freq_area_res %>%
  dplyr::select(-est_freq_area)

results <- results %>%
  left_join(area_join, by = c("subsection" = "subsection",
                   "response" = "response"))
```

```{r}
# Direct estimates
strata <- read_csv("../data/population/strata.csv")

dirmean <- list()
dirmean[1:12] <- lapply(iw, direct_estimate, response = "BIOLIVE_TPA", "subsection")
dirmean[13:24] <- lapply(iw, direct_estimate, response = "BALIVE_TPA", "subsection")
dirmean[25:36] <- lapply(iw, direct_estimate, response = "CNTLIVE_TPA", "subsection")
dirmean[37:48] <- lapply(iw, direct_estimate, response = "VOLNLIVE_TPA", "subsection")

dir <- bind_rows(dirmean) %>%
  dplyr::select(Domain, Direct, CV) %>%
  mutate(cov_dirmean = CV / 100) %>%
  rename(est_dirmean = Direct) %>%
  dplyr::select(-CV) %>%
  mutate(response = c(
    rep("BIOLIVE_TPA", 428),
    rep("BALIVE_TPA", 428),
    rep("CNTLIVE_TPA", 428),
    rep("VOLNLIVE_TPA", 428)))

results <- results %>%
  left_join(dir, by = c("subsection" = "Domain",
                        "response" = "response"))
```

