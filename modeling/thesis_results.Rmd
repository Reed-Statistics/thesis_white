---
title: "Thesis Results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mase)
library(hbsae)
library(sae)
```

## Data
### Loading
```{r load_data, message = FALSE, warning = FALSE}
intwest <- read_csv("../data/subsets/df.csv")
tccpop <- read_csv("../data/population/tcc_pop.csv")
strata <- read_csv("../data/population/strata.csv")
```

### Cleaning

Set up strata:
```{r clean_data, message = FALSE, warning = FALSE}
intwest <- intwest %>%
  mutate(FIAstrat = case_when(
    FIAstrat == "1" ~ "Sampled-Forest",
    FIAstrat == "2" ~ "Sampled-Nonforest",
    FIAstrat == "0" ~ "Sampled-Nonforest",
    FIAstrat == "3" ~ "Sampled-Nonforest",
  )) 
```

Initial data changes to avoid horrific errors:
```{r}
no0_subsections <- intwest %>%
  group_by(subsection) %>%
  summarize(mean_y = mean(BIOLIVE_TPA),
            mean_x = mean(nlcd11)) %>%
  filter(mean_y > 0 & mean_x > 0) %>% # remove subsections that only contain 0 
  dplyr::select(subsection) %>%
  pull()

intwest_no0 <- intwest %>%
  filter(subsection %in% no0_subsections) %>%
  filter(!(province %in% c("M261", "M334")))
```

List of dataframes:
```{r}
iw <- split(intwest_no0, f = intwest_no0$province)
## we deal with the below in the above chunk
# iw <- iw[-13] # This province only has two subsections and causes divergent integrals
# iw <- iw[-8] # This province only has two subsections and causes divergent integrals
```

## Modeling

### Source modeling functions
```{r modeling_fcns}
source("../modeling-functions/direct_CoV.R")
source("../modeling-functions/direct_estimate.R")
source("../modeling-functions/freq_area.R")
source("../modeling-functions/freq_area_CoV.R")
source("../modeling-functions/freq_unit.R")
source("../modeling-functions/freq_unit_CoV.R")
source("../modeling-functions/hb_area.R")
source("../modeling-functions/hb_CoV.R")
source("../modeling-functions/hb_unit.R")
```

### Post-stratification and the mean

```{r postStrat, message = FALSE}
strata <- strata %>%
  filter(zoneid %in% unique(intwest_no0$subsection)) %>%
  mutate(
    fnf_no_water = case_when(
      fnf_no_water == 1 ~ "Sampled-Forest",
      fnf_no_water == 2 ~ "Sampled-Nonforest"
    )
  )
strata <- strata %>%
  dplyr::select(-zoneprop)

# split strata into list and drop column split by
strata_list <- lapply(split(strata, f = strata$zoneid), function(strata) { strata$zoneid <- NULL; strata})

# split subsections into list
subsection_list <- split(intwest_no0, intwest_no0$subsection)

postStrat2_bio <- function(data, strata) {
  est <- mase::postStrat(y = data[["BIOLIVE_TPA"]],
                  x_sample = data[["FIAstrat"]],
                  x_pop = strata,
                  data_type = "totals",
                  var_est = T)
  return(data.frame(ps_est = est$pop_mean, sd = sqrt(est$pop_mean_var)))
}
postStrat2_ba <- function(data, strata) {
  est <- mase::postStrat(y = data[["BALIVE_TPA"]],
                  x_sample = data[["FIAstrat"]],
                  x_pop = strata,
                  data_type = "totals",
                  var_est = T)
  return(data.frame(ps_est = est$pop_mean, sd = sqrt(est$pop_mean_var)))
}

postStrat2_voln <- function(data, strata) {
  est <- mase::postStrat(y = data[["VOLNLIVE_TPA"]],
                  x_sample = data[["FIAstrat"]],
                  x_pop = strata,
                  data_type = "totals",
                  var_est = T)
  return(data.frame(ps_est = est$pop_mean, sd = sqrt(est$pop_mean_var)))
}

postStrat2_cnt <- function(data, strata) {
  est <- mase::postStrat(y = data[["CNTLIVE_TPA"]],
                  x_sample = data[["FIAstrat"]],
                  x_pop = strata,
                  data_type = "totals",
                  var_est = T)
  return(data.frame(ps_est = est$pop_mean, sd = sqrt(est$pop_mean_var)))
}

post_strat_bio <- map2(.x = subsection_list, .y = strata_list, .f = postStrat2_bio)
post_strat_ba <- map2(.x = subsection_list, .y = strata_list, .f = postStrat2_ba)
post_strat_voln <- map2(.x = subsection_list, .y = strata_list, .f = postStrat2_voln)
post_strat_cnt <- map2(.x = subsection_list, .y = strata_list, .f = postStrat2_cnt)

results <- data.frame(
  ps_est = c(bind_rows(post_strat_bio)$ps_est,
             bind_rows(post_strat_ba)$ps_est,
             bind_rows(post_strat_cnt)$ps_est,
             bind_rows(post_strat_voln)$ps_est),
  ps_sd = c(bind_rows(post_strat_bio)$sd,
             bind_rows(post_strat_ba)$sd,
             bind_rows(post_strat_cnt)$sd,
             bind_rows(post_strat_voln)$sd),
  subsection = rep(names(post_strat_bio), 4),
  response = c(
    rep("BIOLIVE_TPA", 428),
    rep("BALIVE_TPA", 428),
    rep("CNTLIVE_TPA", 428),
    rep("VOLNLIVE_TPA", 428))
)
```

```{r mean}
dirmean <- list()
dirmean[1:12] <- lapply(iw, direct_estimate, response = "BIOLIVE_TPA", "subsection")
dirmean[13:24] <- lapply(iw, direct_estimate, response = "BALIVE_TPA", "subsection")
dirmean[25:36] <- lapply(iw, direct_estimate, response = "CNTLIVE_TPA", "subsection")
dirmean[37:48] <- lapply(iw, direct_estimate, response = "VOLNLIVE_TPA", "subsection")

dir <- bind_rows(dirmean) %>%
  dplyr::select(Domain, Direct, CV) %>%
  mutate(cov_dirmean = CV / 100) %>%
  rename(est_dirmean = Direct) %>%
  dplyr::select(-CV) %>%
  mutate(response = c(
    rep("BIOLIVE_TPA", 428),
    rep("BALIVE_TPA", 428),
    rep("CNTLIVE_TPA", 428),
    rep("VOLNLIVE_TPA", 428)))

results <- results %>%
  left_join(dir, by = c("subsection" = "Domain",
                        "response" = "response"))
```

```{r dataframe-cleanup}
# Create CoV for ps-estimator
results <- results %>%
  mutate(
    cov_dirps = ps_sd / est_dirmean
  )

# change names and rearrange 
results <- results %>%
  rename(est_dirps = ps_est,
         sd_dirps = ps_sd) %>%
  relocate("subsection", "response", "est_dirps", "cov_dirps")
```

```{r}
# set up list for area level models
ps_dat <- results %>%
  dplyr::select(est_dirps, sd_dirps, subsection, response) %>%
  dplyr::mutate(var = sd_dirps^2) %>%
  dplyr::rename(est = est_dirps) %>%
  dplyr::select(est, var, subsection, response) %>%
  dplyr::mutate(province = str_sub(results$subsection, 1, -3))

ps_l <- split(ps_dat, list(ps_dat$response, ps_dat$province))
```



### Hierarchical Bayesian Modeling

```{r}
# HB Unit
set.seed(1)
bayes_unit <- list()
bayes_unit[1:12] <- lapply(iw, hb_unit, formula = BIOLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[13:24] <- lapply(iw, hb_unit, formula = BALIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[25:36] <- lapply(iw, hb_unit, formula = CNTLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)
bayes_unit[37:48] <- lapply(iw, hb_unit, formula = VOLNLIVE_TPA ~ nlcd11, small_area = "subsection", pop_data = tccpop)

# saveRDS(bayes_unit, "bayes_unit.rds")

res_hbu <- data.frame(
  subsection = names(unlist(lapply(bayes_unit, EST))),
  response = c(rep("BIOLIVE_TPA", 428),
               rep("BALIVE_TPA", 428),
               rep("CNTLIVE_TPA", 428), 
               rep("VOLNLIVE_TPA", 428)),
  est_hb_unit = unlist(lapply(bayes_unit, EST)),
  cov_hb_unit = unlist(lapply(bayes_unit, hb_CoV))
)

results <- results %>%
  left_join(res_hbu, by = c("subsection" = "subsection",
                        "response" = "response"))
```

```{r}

```




