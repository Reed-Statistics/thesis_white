---
title: "Exploratory Data Analysis"
author: "Grayson White"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```


## Data wrangling:
```{r message = FALSE, warning = FALSE}
# Import data
spatial <- read_csv("../data/plot_level/plt_spatial.csv")
response <- read_csv("../data/plot_level/plot_response.csv")

# Join data
## Keep only observations in both `spatial` and `response`
dat <- inner_join(spatial, response, 
                  by = c("PLT_CN" = "PLT_CN",
                         "INVYR" = "INVYR"))

# Create columns for province, sections, and subsections
dat <- dat %>%
  mutate(
    subsection = ECOSUBCD.x,
    section = str_remove_all(ECOSUBCD.x, "[:lower:]"),
    province = str_sub(section, end = -2)
  )

# Select small subset of columns to work with for this EDA
dat_small <- dat %>%
  select(PLT_CN, INVYR, PLOT.x, LON_PUBLIC.x, LAT_PUBLIC.x, LON_PUBLIC.y, LAT_PUBLIC.y,
         ELEV_PUBLIC.x, ELEV_PUBLIC.y, forgrp, forprob, nlcd11, demLF, evtLF, forbio,
         BALIVE_TPA, CNTLIVE_TPA, BIOLIVE_TPA, VOLNLIVE_TPA, subsection, section, province)

# Check if a couple of columns are the same
all.equal(dat_small$LON_PUBLIC.x, dat_small$LON_PUBLIC.y)
all.equal(dat_small$LAT_PUBLIC.x, dat_small$LAT_PUBLIC.y)
all.equal(dat_small$ELEV_PUBLIC.x, dat_small$ELEV_PUBLIC.y)

# Remove redundent columns, rename columns for ease of use
dat_small <- dat_small %>%
  select(-LON_PUBLIC.y, -LAT_PUBLIC.y, -ELEV_PUBLIC.y) %>%
  rename(PLOT = PLOT.x,
         LON_PUBLIC = LON_PUBLIC.x,
         LAT_PUBLIC = LAT_PUBLIC.x,
         ELEV_PUBLIC = ELEV_PUBLIC.x)
```


## Exploratory Data Analysis

I will first look into the province `M333`, which is the Northern Rocky Mountain Forest. This province has a maritime-influenced cool temperate climate with warm, dry summers and cold, moist winters with heavy snowfall. Small areas of glaciers occur near the Canadian border. High-elevation, high-relief mountains are the main landforms.

```{r}
# Create dataframe
north_rocky <- dat_small %>%
  filter(province == "M333")

# Summary stats
north_rocky %>%
  summarize(
    mean_forprob = mean(forprob),
    mean_forbio = mean(forbio)
  )

# Distribution of variables
ggplot(north_rocky,
       aes(x = forprob)) +
  geom_histogram(bins = 20, fill = "darkgreen",  color = "black") +
  theme_bw()

ggplot(north_rocky,
       aes(x = forbio)) +
  geom_histogram(bins = 20, fill = "darkgreen",  color = "black") +
  theme_bw()

# forest biomass, by forest group

## filter to groups with greater than 100 observations
forgrp_big <- north_rocky %>%
  group_by(forgrp) %>%
  summarize(count = n()) %>%
  filter(count > 100 & forgrp != 0) %>%
  pull(forgrp)


north_rocky %>%
  filter(forgrp %in% forgrp_big) %>%
ggplot(aes(x = forbio)) +
  geom_histogram(bins = 20, fill = "darkgreen",  color = "black") +
  theme_bw() +
  facet_wrap(~forgrp, nrow = 3)
```


Here we go, time to make a map :-)

```{r}
library(sf)
library(USAboundaries)
`%ni%` <- Negate(`%in%`)

interior_west <- c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY")

states <- data.frame(state.abb) %>%
  filter(state.abb %ni% interior_west & state.abb %ni% c("AK", "HI")) %>%
  pull()


# The interior west plotted in green on the USA
ggplot(data = north_rocky) +
  geom_sf(data = us_boundaries(type = "state",
                               states = interior_west),
          fill = "#597058",
          color = "black") +
  geom_sf(data = us_boundaries(type = "state",
                               states = states),
          fill = "grey",
          color = "black") +
  theme_minimal() +
  labs(
    title = "The Interior West"
  ) 
```

```{r}
# Add the north rocky forest onto the interior west map
library(concaveman)

points <- north_rocky %>%
  st_as_sf(coords = c("LON_PUBLIC", "LAT_PUBLIC"), crs = 4326)

forest <- concaveman(points)

ggplot(data = north_rocky) +
  geom_sf(data = forest,
          fill = "#C96733",
          color = "black") +
  theme_minimal()

ggplot(data = north_rocky) +
  geom_sf(data = us_boundaries(type = "state",
                               states = interior_west),
          fill = "#597058",
          color = "black") +
  geom_sf(data = us_boundaries(type = "state",
                               states = states),
          fill = "grey",
          color = "black") +
  geom_sf(data = forest,
          fill = "#C96733",
          color = "black") +
  theme_minimal() +
  labs(
    title = "The Interior West with the North Rocky Forest"
  ) 
```


Time to use the data on these nice maps:
```{r}
ggplot(data = north_rocky) +
  geom_sf(data = us_boundaries(type = "state",
                               states = c("ID", "MT", "WY")),
          fill = "lightgrey",
          color = "black") +
  # geom_sf(data = forest,
  #         fill = "#C96733",
  #         color = "black") +
  stat_summary_hex(data = north_rocky,
                  fun = function(x) mean(x),
          aes(x = LON_PUBLIC,
              y = LAT_PUBLIC,
              z = forprob)) +
  scale_fill_gradient(low = "lightgrey", high = "#597058") +
  theme_minimal()


ggplot(data = north_rocky) +
  geom_sf(data = forest) +
  stat_summary_hex(data = north_rocky,
                  fun = function(x) mean(x),
          aes(x = LON_PUBLIC,
              y = LAT_PUBLIC,
              z = forprob)) +
  theme_minimal() +
  scale_fill_gradient(low = "lightgrey", high = "#597058")
```

Let's take a step back and look at probabilty of forest over a larger area:

```{r}
ggplot(data = north_rocky) +
  stat_summary_hex(
    data = dat_small,
    fun = function(x)
      mean(x),
    aes(x = LON_PUBLIC,
        y = LAT_PUBLIC,
        z = forprob),
    bins = 50
  ) +
  geom_sf(
    data = us_boundaries(type = "state",
                         states = c(states, interior_west)),
    fill = NA,
    color = "black"
  ) +
  scale_fill_gradient(low = "lightgrey", high = "#597058") +
  theme_minimal()
```

Zooming into the interior west:

```{r}
ggplot(data = north_rocky) +
  stat_summary_hex(
    data = dat_small,
    fun = function(x)
      mean(x),
    aes(x = LON_PUBLIC,
        y = LAT_PUBLIC,
        z = forprob),
    bins = 50
  ) +
  geom_sf(
    data = us_boundaries(type = "state",
                         states = c(interior_west)),
    fill = NA,
    color = "black"
  ) +
  scale_fill_gradient(low = "lightgrey", high = "#597058") +
  theme_minimal()
```


Now, let's explore areas that are likely (>0.75) forests.

```{r}
forest75 <- dat_small %>%
  filter(forprob > 0.75)

# summary stats by province

forest75_summaries <- forest75 %>%
  group_by(province) %>%
  summarize(
    mean_basal_area = mean(BALIVE_TPA),
    mean_CNT = mean(CNTLIVE_TPA),
    mean_BIO = mean(BIOLIVE_TPA),
    mean_VOLN = mean(VOLNLIVE_TPA),
    mean_biomass = mean(forbio)
  )
forest75_summaries

# Learning more about distribution of these variables in likely forests:
## Mountain or not variable:
forest75 <- forest75 %>%
  mutate(
    mountain = case_when(
      province %in% c("M313", "M331", "M341", "M333", "M332", "M261", "M334") ~ 1,
      TRUE ~ 0
    )
  )

## By province
ggplot(forest75,
       aes(y = BALIVE_TPA,
           x = province)) +
  geom_violin() +
  theme_bw()

## by mtn vs. not
ggplot(forest75,
       aes(x = factor(mountain),
           y = BALIVE_TPA)) +
  geom_violin() +
  theme_bw()

ggplot(forest75,
       aes(x = factor(mountain),
           y = BALIVE_TPA)) +
  geom_boxplot(alpha = 0.2) +
  theme_bw()

## we could do a t test to see if these are really different
t.test(BALIVE_TPA ~ mountain, data = forest75)

## do any response variables have very similar means between mountain vs not?
t.test(BIOLIVE_TPA ~ mountain, data = forest75)
t.test(CNTLIVE_TPA ~ mountain, data = forest75)
t.test(VOLNLIVE_TPA ~ mountain, data = forest75)

### no, these are all pretty different. interesting. 
```



